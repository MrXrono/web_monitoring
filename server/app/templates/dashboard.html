{% extends "base.html" %}

{% block title %}{{ _('Dashboard') }} - RAID Monitor{% endblock %}

{% block content %}
<div x-data="dashboardApp()" x-init="init()">
  <!-- Summary Cards Row -->
  <div class="row g-3 mb-4">
    <!-- Servers Card -->
    <div class="col-6 col-lg-3">
      <div class="card summary-card border-0 shadow-sm h-100">
        <div class="card-body p-3">
          <div class="d-flex align-items-center">
            <div class="summary-icon bg-primary bg-opacity-10 text-primary rounded-3 p-2 me-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-server" viewBox="0 0 16 16">
                <path d="M1.333 2.667C1.333 1.194 4.318 0 8 0s6.667 1.194 6.667 2.667V4c0 1.473-2.985 2.667-6.667 2.667S1.333 5.473 1.333 4V2.667z"/>
                <path d="M1.333 6.334v3C1.333 10.805 4.318 12 8 12s6.667-1.194 6.667-2.667V6.334a8.636 8.636 0 0 1-1.455.987C11.588 8.152 9.85 8.667 8 8.667s-3.588-.515-5.212-1.346a8.634 8.634 0 0 1-1.455-.987z"/>
                <path d="M14.667 10.334a8.636 8.636 0 0 1-1.455.987C11.588 12.152 9.85 12.667 8 12.667s-3.588-.515-5.212-1.346a8.636 8.636 0 0 1-1.455-.987V13.333C1.333 14.806 4.318 16 8 16s6.667-1.194 6.667-2.667v-3z"/>
              </svg>
            </div>
            <div>
              <div class="text-muted small">{{ _('Servers') }}</div>
              <div class="fw-bold fs-4">
                <span class="text-success">{{ stats.servers_online | default(0) }}</span>
                <span class="text-muted fs-6">/ {{ stats.servers_total | default(0) }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Controllers Card -->
    <div class="col-6 col-lg-3">
      <div class="card summary-card border-0 shadow-sm h-100">
        <div class="card-body p-3">
          <div class="d-flex align-items-center">
            <div class="summary-icon bg-info bg-opacity-10 text-info rounded-3 p-2 me-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-cpu" viewBox="0 0 16 16">
                <path d="M5 0a.5.5 0 0 1 .5.5V2h1V.5a.5.5 0 0 1 1 0V2h1V.5a.5.5 0 0 1 1 0V2h1V.5a.5.5 0 0 1 1 0V2A2.5 2.5 0 0 1 14 4.5h1.5a.5.5 0 0 1 0 1H14v1h1.5a.5.5 0 0 1 0 1H14v1h1.5a.5.5 0 0 1 0 1H14v1h1.5a.5.5 0 0 1 0 1H14A2.5 2.5 0 0 1 11.5 14v1.5a.5.5 0 0 1-1 0V14h-1v1.5a.5.5 0 0 1-1 0V14h-1v1.5a.5.5 0 0 1-1 0V14h-1v1.5a.5.5 0 0 1-1 0V14A2.5 2.5 0 0 1 2 11.5H.5a.5.5 0 0 1 0-1H2v-1H.5a.5.5 0 0 1 0-1H2v-1H.5a.5.5 0 0 1 0-1H2v-1H.5a.5.5 0 0 1 0-1H2A2.5 2.5 0 0 1 4.5 2V.5A.5.5 0 0 1 5 0zm-.5 3A1.5 1.5 0 0 0 3 4.5v7A1.5 1.5 0 0 0 4.5 13h7a1.5 1.5 0 0 0 1.5-1.5v-7A1.5 1.5 0 0 0 11.5 3h-7zM5 6.5A1.5 1.5 0 0 1 6.5 5h3A1.5 1.5 0 0 1 11 6.5v3A1.5 1.5 0 0 1 9.5 11h-3A1.5 1.5 0 0 1 5 9.5v-3zM6.5 6a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3z"/>
              </svg>
            </div>
            <div>
              <div class="text-muted small">{{ _('Controllers') }}</div>
              <div class="fw-bold fs-4">
                {{ stats.controllers_total | default(0) }}
                {% if stats.swraid_total is defined and stats.swraid_total > 0 %}
                <span class="text-muted fs-6">/ </span><span class="fs-5" title="{{ _('Software RAID') }}">{{ stats.swraid_total }} SW</span>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Virtual Drives Card -->
    <div class="col-6 col-lg-3">
      <div class="card summary-card border-0 shadow-sm h-100">
        <div class="card-body p-3">
          <div class="d-flex align-items-center">
            <div class="summary-icon rounded-3 p-2 me-3
              {% if stats.vd_problem is defined and stats.vd_problem > 0 %}bg-danger bg-opacity-10 text-danger{% else %}bg-success bg-opacity-10 text-success{% endif %}">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-hdd" viewBox="0 0 16 16">
                <path d="M4.5 11a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1zM3 10.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0z"/>
                <path d="M16 11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V9.51c0-.418.105-.83.305-1.197l2.472-4.531A1.5 1.5 0 0 1 4.094 3h7.812a1.5 1.5 0 0 1 1.317.782l2.472 4.53c.2.368.305.78.305 1.198V11zM3.655 4.26 1.592 8.043C1.724 8.014 1.86 8 2 8h12c.14 0 .276.014.408.042L12.345 4.26a.5.5 0 0 0-.439-.26H4.094a.5.5 0 0 0-.44.26zM1 10v1a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-1a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1z"/>
              </svg>
            </div>
            <div>
              <div class="text-muted small">{{ _('Virtual Drives') }}</div>
              <div class="fw-bold fs-4">
                <span class="text-success">{{ stats.vd_ok | default(0) }}</span>
                <span class="text-muted fs-6">/ {{ stats.vd_total | default(0) }}</span>
              </div>
              {% if stats.vd_problem is defined and stats.vd_problem > 0 %}
              <small class="text-danger">{{ stats.vd_problem }} {{ _('problem') }}</small>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Physical Drives Card -->
    <div class="col-6 col-lg-3">
      <div class="card summary-card border-0 shadow-sm h-100">
        <div class="card-body p-3">
          <div class="d-flex align-items-center">
            <div class="summary-icon rounded-3 p-2 me-3
              {% if stats.pd_problem is defined and stats.pd_problem > 0 %}bg-danger bg-opacity-10 text-danger{% else %}bg-success bg-opacity-10 text-success{% endif %}">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-device-hdd" viewBox="0 0 16 16">
                <path d="M12 2.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0Zm0 11a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0Zm-7.5.5a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1ZM5 2.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0ZM8 8a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z"/>
                <path d="M12 7a4 4 0 0 1-3.937 4c-.27.007-.547-.04-.812-.105a3.16 3.16 0 0 1-.593-.225A4.008 4.008 0 0 1 4 7a4 4 0 0 1 8 0ZM8 4a3 3 0 1 0 0 6 3 3 0 0 0 0-6Z"/>
                <path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H4Z"/>
              </svg>
            </div>
            <div>
              <div class="text-muted small">{{ _('Physical Drives') }}</div>
              <div class="fw-bold fs-4">
                <span class="text-success">{{ stats.pd_ok | default(0) }}</span>
                <span class="text-muted fs-6">/ {{ stats.pd_total | default(0) }}</span>
              </div>
              {% if stats.pd_problem is defined and stats.pd_problem > 0 %}
              <small class="text-danger">{{ stats.pd_problem }} {{ _('problem') }}</small>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filter Bar -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body p-3">
      <form id="filter-form" class="row g-2 align-items-end"
            hx-get="/dashboard"
            hx-target="#server-list"
            hx-swap="innerHTML"
            hx-trigger="submit, change from:.auto-filter"
            hx-push-url="true"
            hx-select="#server-list-inner">
        <div class="col-12 col-md-5">
          <label for="search" class="form-label small text-muted mb-1">{{ _('Search') }}</label>
          <div class="input-group input-group-sm">
            <span class="input-group-text bg-white">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-search text-muted" viewBox="0 0 16 16">
                <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
              </svg>
            </span>
            <input type="text" class="form-control" id="search" name="search"
                   placeholder="{{ _('Search hostname or IP...') }}"
                   value="{{ search | default('') }}"
                   hx-get="/dashboard"
                   hx-target="#server-list"
                   hx-swap="innerHTML"
                   hx-trigger="keyup changed delay:300ms"
                   hx-select="#server-list-inner"
                   hx-include="[name='status'],[name='sort']">
          </div>
        </div>
        <div class="col-6 col-md-3">
          <label for="status-filter" class="form-label small text-muted mb-1">{{ _('Status') }}</label>
          <select class="form-select form-select-sm auto-filter" id="status-filter" name="status"
                  hx-get="/dashboard"
                  hx-target="#server-list"
                  hx-swap="innerHTML"
                  hx-select="#server-list-inner"
                  hx-include="[name='search'],[name='sort']">
            <option value="" {% if not status_filter %}selected{% endif %}>{{ _('All') }}</option>
            <option value="online" {% if status_filter == 'online' %}selected{% endif %}>{{ _('Online') }}</option>
            <option value="warning" {% if status_filter == 'warning' %}selected{% endif %}>{{ _('Warning') }}</option>
            <option value="critical" {% if status_filter == 'critical' %}selected{% endif %}>{{ _('Critical') }}</option>
            <option value="offline" {% if status_filter == 'offline' %}selected{% endif %}>{{ _('Offline') }}</option>
          </select>
        </div>
        <div class="col-6 col-md-3">
          <label for="sort-select" class="form-label small text-muted mb-1">{{ _('Sort') }}</label>
          <select class="form-select form-select-sm auto-filter" id="sort-select" name="sort"
                  hx-get="/dashboard"
                  hx-target="#server-list"
                  hx-swap="innerHTML"
                  hx-select="#server-list-inner"
                  hx-include="[name='search'],[name='status']">
            <option value="hostname" {% if sort == 'hostname' %}selected{% endif %}>{{ _('Hostname') }}</option>
            <option value="status" {% if sort == 'status' %}selected{% endif %}>{{ _('Status') }}</option>
            <option value="last_seen" {% if sort == 'last_seen' %}selected{% endif %}>{{ _('Last Seen') }}</option>
          </select>
        </div>
        <div class="col-12 col-md-1 d-flex justify-content-end">
          <button type="button" class="btn btn-sm btn-outline-secondary" title="{{ _('Refresh') }}"
                  hx-get="/dashboard"
                  hx-target="#server-list"
                  hx-swap="innerHTML"
                  hx-select="#server-list-inner"
                  hx-include="[name='search'],[name='status'],[name='sort']">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
              <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
              <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
            </svg>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Server List -->
  <div id="server-list"
       hx-get="/dashboard?partial=1"
       hx-trigger="every 60s"
       hx-swap="innerHTML"
       hx-select="#server-list-inner"
       hx-include="#filter-form">
    <div id="server-list-inner">
      {% if servers is defined and servers | length > 0 %}
      <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3">
        {% for server in servers %}
        {% include 'components/server_card.html' %}
        {% endfor %}
      </div>

      {% if pagination is defined %}
      <div class="mt-4">
        {% include 'components/pagination.html' %}
      </div>
      {% endif %}
      {% else %}
      <!-- Empty State -->
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-server text-muted mb-3" viewBox="0 0 16 16">
            <path d="M1.333 2.667C1.333 1.194 4.318 0 8 0s6.667 1.194 6.667 2.667V4c0 1.473-2.985 2.667-6.667 2.667S1.333 5.473 1.333 4V2.667z"/>
            <path d="M1.333 6.334v3C1.333 10.805 4.318 12 8 12s6.667-1.194 6.667-2.667V6.334a8.636 8.636 0 0 1-1.455.987C11.588 8.152 9.85 8.667 8 8.667s-3.588-.515-5.212-1.346a8.634 8.634 0 0 1-1.455-.987z"/>
            <path d="M14.667 10.334a8.636 8.636 0 0 1-1.455.987C11.588 12.152 9.85 12.667 8 12.667s-3.588-.515-5.212-1.346a8.636 8.636 0 0 1-1.455-.987V13.333C1.333 14.806 4.318 16 8 16s6.667-1.194 6.667-2.667v-3z"/>
          </svg>
          <h5 class="text-muted">{{ _('No servers found') }}</h5>
          <p class="text-muted mb-0">{{ _('Servers will appear here once agents start reporting.') }}</p>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
function dashboardApp() {
  return {
    init() {
      // Auto-refresh is handled by HTMX hx-trigger="every 60s"
      this.updateRelativeTimes();
      setInterval(() => this.updateRelativeTimes(), 30000);
    },
    updateRelativeTimes() {
      document.querySelectorAll('.relative-time[data-timestamp]').forEach(el => {
        const ts = el.getAttribute('data-timestamp');
        if (ts) {
          el.textContent = window.RaidMonitor.formatRelativeTime(ts);
        }
      });
    }
  };
}
</script>
{% endblock %}
